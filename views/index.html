<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title><%= title %></title>
        <link rel="stylesheet" href="/css/style.css">
    </head>
    <script src="/socket.io/socket.io.js"></script>

    <script src="/js/socket-model.js"></script>

    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>

    <script src="/js/vendors/moment/moment.js"></script>
    <script src="/js/vendors/moment-timezone/builds/moment-timezone-with-data.min.js"></script>

    <script src="https://rawgit.com/highslide-software/highcharts.com/master/js/themes/dark-unica.js"></script>

    <body>
     <!-- create the div for the chart -->
     <div id="temperature" style="width:100%; height:200px;"></div>
     <div id="humidity" style="width:100%; height:200px;"></div>
     <div id="sound" style="width:100%; height:200px;"></div>
     <!-- Start of Javascript -->
    <script>

     // create the websocket; for intranet use the ip-address of the raspberry pi suffices;
    var socket = io.connect('http://127.0.0.1:3000');
    window.socket = socket;

    socket.on('device.create', function(device){
        console.log('DEVICE CREATED', device);
        var model = device;
        if(typeof model.t === 'string') model.t = parseFloat(model.t);
        if(isNaN(model.t)) return
        temp.series[0].addPoint(model.t, 1, 1);

        if(typeof model.h === 'string') model.h = parseFloat(model.h);
        if(isNaN(model.h)) return
        hum.series[0].addPoint(model.h, 1, 1);
    });

    socket.on('device.update', function(device){
        console.log('DEVICE UPDATED', device);
    });

    socket.on('device.error', function(device){
        console.log('DEVICE ERROR', device);
    });

    window.sm = new SocketModel('http://127.0.0.1:3000');

    var temp,
        hum,
        sound,
        startDate = new Date(Date.now());
    var now = new Date(startDate.getTime()+startDate.getTimezoneOffset()*60*1000);
    startDate = Date.UTC(now.getUTCFullYear(),now.getUTCMonth(), now.getUTCDate() ,
      now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds(), now.getUTCMilliseconds());

    window.temp =
    temp = new Highcharts.Chart({
        chart: {
            renderTo: 'temperature',
            events: {
                load: function() {
                    socket.on('initialize', function (values) {
                        console.log(values)
                        temp.series[0].setData(values);
                    });

                    socket.on('update', function(data) {
                        console.log('UPDATE', data);
                        data.forEach(function(model){
                            if(typeof model.t === 'string') model.t = parseFloat(model.t);
                            if(isNaN(model.t)) return
                            temp.series[0].addPoint(model.t, 1, 1);
                        });
                    });
                }
            }
        },
        title: {
            text: 'Temperature (C)'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            maxZoom: 20 * 1000
        },
        yAxis: {
            title: {
                text: 'C',
                margin: 80
            }
        },
        plotOptions: {
            series: {
                marker: {
                    radius: 2
                }
            }
        },
        series: [{
            name: 'Temperature',
            type: 'area',
            pointStart:startDate,
            pointInterval: 16 * 1000,
            data: []
        }]
     });

    window.hum =
    hum = new Highcharts.Chart({
        chart: {
            renderTo: 'humidity',
            events: {
                load: function() {

                    console.log('loaded')
                    socket.on('initialize', function (values) {
                        console.log(values)
                        hum.series[0].setData(values);
                    });

                    socket.on('update', function(data) {
                        // console.log('UPDATE', model);
                        console.log('UPDATE', data);
                        data.forEach(function(model){
                            if(typeof model.h === 'string') model.h = parseFloat(model.h);
                            if(isNaN(model.h)) return
                            hum.series[0].addPoint(model.h, 1, 1);
                        });
                    });
                }
            }
        },
        title: {
            text: 'Humidity (%)'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            maxZoom: 20 * 1000
        },
        yAxis: {
            title: {
                text: '%',
                margin: 80
            }
        },
        plotOptions: {
            series: {
                marker: {
                    radius: 2
                }
            }
        },
        series: [{
            name: 'Temperature',
            type: 'area',
            pointStart:startDate,
            pointInterval: 16 * 1000,
            data: []
        }]
     });

    window.sound =
    sound = new Highcharts.Chart({
        chart: {
            renderTo: 'sound',
            events: {
                load: function() {

                    console.log('loaded')
                    socket.on('initialize', function (values) {
                        console.log(values)
                        sound.series[0].setData(values);
                    });

                    socket.on('update', function(data) {
                        // console.log('UPDATE', model);
                        console.log('UPDATE', data);
                        data.forEach(function(model){
                            if(typeof model.s === 'string') model.s = parseFloat(model.s);
                            if(isNaN(model.s)) return
                            sound.series[0].addPoint(model.s, 1, 1);
                        });
                    });
                }
            }
        },
        title: {
            text: 'Sound (dB)'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            maxZoom: 20 * 1000
        },
        yAxis: {
            title: {
                text: 'dB',
                margin: 80
            }
        },
        plotOptions: {
            series: {
                marker: {
                    radius: 2
                }
            }
        },
        series: [{
            name: 'Sound',
            type: 'area',
            pointStart:startDate,
            pointInterval: 16 * 1000,
            data: []
        }]
     });
    var uuid = "xyz";
    function fakeData(){

        function randomInt(min, max){
            return Math.floor(Math.random() * (max - min + 1) + min);
        }

        var payload = {
            uuid: uuid,
            t: randomInt(40, 60),
            h: randomInt(20, 60),
            tmp: Date.now()
        };

        $.ajax({
            url: 'http://localhost:3000/sensor/collect',
            type: 'POST',
            contentType: "application/json",
            dataType: 'json',
            data: JSON.stringify(payload)
        }).done(function(response){
            setTimeout(fakeData, 16 * 100);
        });
    }

    </script>
    <script src="js/vendors/requirejs/require.js" data-main="js/main.js"></script>
 </body>
</html>
